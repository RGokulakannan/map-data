import os
import time
import pandas as pd
import shutil
import openpyxl
from selenium import webdriver
from selenium.webdriver.support.wait import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import Select
from selenium.webdriver.chrome.options import Options
from webdriver_manager.chrome import ChromeDriverManager
from selenium.webdriver.chrome.service import Service
from tqdm import tqdm
from datetime import datetime, timedelta
import pyautogui
from selenium.webdriver import Keys

user_name = os.getlogin()

def open_chrome():
    profile = 'Default'
    profile_path = f'C:\\Users\\{user_name}\\AppData\\Local\\Google\\Chrome\\User Data\\Default'
    options = Options()
    options.add_argument(f'user-data-dir={profile_path}')
    options.add_argument(f'--profile-directory={profile}')
    options.add_experimental_option('excludeSwitches', ['enable-logging'])
    options.add_argument('--disable-dev-shm-usage')
    options.add_argument('--start-maximized')
    options.add_argument('--no-sandbox')
    options.add_argument('--disable-gpu')
    service = Service("C:\\Users\\"+user_name+"\\driver\\chromedriver.exe")
    driver = webdriver.Chrome(service=service, options=options)
    return driver

def drop_down_select(text1, text2):
    
    dropdown = driver.find_element(By.ID, text1)
    select = Select(dropdown)
    select.select_by_visible_text(text2)
    
driver = open_chrome()

df = pd.read_excel("Input_BQE.xlsx")

for index, row in df.iterrows():
    print(index, end="-")
    driver.get("about:blank")
    driver.get("https://csi.amazon.com/diag/Catalog_Issues_Troubleshooter?resourcePath=Catalog_Issues_Troubleshooter")
    WebDriverWait(driver, 60, poll_frequency=1).until(EC.visibility_of_element_located((By.XPATH, "//input[@value='browse_related']")))    
    driver.execute_script("window.scrollTo(0, document.body.scrollHeight);")
    time.sleep(0.3)
    driver.find_element(By.XPATH, "//input[@value='browse_related']").click()
    time.sleep(0.3)
    
    WebDriverWait(driver, 60, poll_frequency=1).until(EC.visibility_of_element_located((By.XPATH, "//input[@value='BQE_related_issues']")))    
    driver.execute_script("window.scrollTo(0, document.body.scrollHeight);")
    time.sleep(0.3)
    driver.find_element(By.XPATH, "//input[@value='BQE_related_issues']").click()
    time.sleep(0.3)
    
    WebDriverWait(driver, 60, poll_frequency=1).until(EC.visibility_of_element_located((By.XPATH, "//input[@value='identify_winner']")))    
    driver.execute_script("window.scrollTo(0, document.body.scrollHeight);")
    time.sleep(0.3)
    driver.find_element(By.XPATH, "//input[@value='identify_winner']").click()
    time.sleep(0.3)
    
    
    WebDriverWait(driver, 60, poll_frequency=1).until(EC.visibility_of_element_located((By.XPATH, "//input[@name='item_id']")))
    driver.execute_script("window.scrollTo(0, document.body.scrollHeight);")
    time.sleep(1)
    driver.find_element(By.XPATH, "//input[@name='item_id']").send_keys(row['ASINs'])
    drop_down_select("marketplace", row["Marketplace"])
    time.sleep(1)
    driver.find_element(By.ID, "submit").click()
    
    WebDriverWait(driver, 60, poll_frequency=1).until(EC.visibility_of_element_located((By.ID, "search_string")))
    time.sleep(1)
    drop_down_select("search_string", row["Attribute Selection"])
    time.sleep(1)
    
    
    
    WebDriverWait(driver, 60, poll_frequency=1).until(EC.visibility_of_element_located((By.XPATH, "//label[text()='No']")))
    driver.execute_script("window.scrollTo(0, document.body.scrollHeight);")
    time.sleep(1)
    driver.find_element(By.XPATH, "//label[text()='No']").click()
    time.sleep(1)
    driver.find_elements(By.ID, "submit")[1].click()
    
    WebDriverWait(driver, 60, poll_frequency=1).until(EC.visibility_of_element_located((By.XPATH, "//input[@name='user_input_merchant_id']")))
    time.sleep(0.3)
    driver.execute_script("window.scrollTo(0, document.body.scrollHeight);")
    time.sleep(0.3)
    driver.find_element(By.XPATH, "//input[@name='user_input_merchant_id']").send_keys("688502606")
    time.sleep(0.3)
    driver.find_element(By.XPATH, "//input[@name='sku']").send_keys(row['ASINs'])
    time.sleep(0.3)
    driver.find_elements(By.ID, "submit")[2].click()
    
    
    WebDriverWait(driver, 60, poll_frequency=1).until(EC.visibility_of_element_located((By.XPATH, "//input[@name='seller_id']")))
    driver.execute_script("window.scrollTo(0, document.body.scrollHeight);")
    time.sleep(1)
    drop_down_select("brand_approval", "No")
    time.sleep(1)
    driver.find_element(By.XPATH, "//input[@name='seller_id']").send_keys("688502606")
    time.sleep(0.3)
    driver.find_element(By.XPATH, "//input[@name='expected_value']").send_keys(row['Attribute value'])
    time.sleep(0.3)
    drop_down_select("team_name", "RBS")
    time.sleep(1)
    driver.find_elements(By.ID, "submit")[3].click()
    
    WebDriverWait(driver, 60, poll_frequency=1).until(EC.visibility_of_element_located((By.XPATH, '//a[text()="SIM"]')))
    
    df.at[index, "sim"] = driver.find_element(By.XPATH, '//a[text()="SIM"]').get_attribute("href")

    # //a[text()="SIM"]
    
df.to_excel("Output_BQE.xlsx", index=False)
driver.quit()


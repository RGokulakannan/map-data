import pandas as pd
import win32com.client as win32

df_resolve = pd.read_csv("r.csv")
df_pending = pd.read_csv("p.csv")
df_assigned = pd.read_csv("a.csv")

# Pending -1

lead_alias = []

with open("lead_alias.txt", mode="r") as f1:
    lead_alias = f1.read()
    lead_alias = lead_alias.splitlines()

mask = (
    (~df_pending['Assigned to'].isin(lead_alias)) & 
    (df_pending['Last updated by'].isin(lead_alias))  & 
    (df_pending['Task type'] == "Subscribe and Save Management") 
    )
df_pending.loc[mask, 'Assigned to'] = df_pending.loc[mask, 'Last updated by']

pivot_table_p = pd.crosstab(df_pending['Assigned to'], df_pending['Task type'])
pivot_table_p['Total'] = pivot_table_p.sum(axis=1)
pivot_table_p = pivot_table_p.reset_index()

if 'Opportunity Buys' in pivot_table_p.columns.to_list():
    pivot_table_p.rename(columns={'Opportunity Buys' : 'Pending-MB'}, inplace=True)
else:
    pivot_table_p["Pending-MB"] = 0
    
pivot_table_p['Pending-Other activity'] = pivot_table_p['Total'] - pivot_table_p['Pending-MB']

# pivot_table_p.to_csv("Pending.csv", index=False)
print(f"Pending Count is {pivot_table_p["Total"].sum()}")
p_ct = pivot_table_p["Total"].sum()

# pending -0

# Assigned -1

pivot_table_a = pd.crosstab(df_assigned['Assigned to'], df_assigned['Status'])
pivot_table_a['Total'] = pivot_table_a.sum(axis=1)
pivot_table_a = pivot_table_a.reset_index()
# pivot_table_a.to_csv("Assigned.csv", index=False)
print(f"Assigned Count is {pivot_table_a["Total"].sum()}")
a_ct = pivot_table_a["Total"].sum()

# Assigned -0

# resolved -1

pivot_table_r = (
    df_resolve
    .groupby('Last resolved by')
    .size()
    .reset_index(name='Resolved')
)
# pivot_table_r.to_csv("Resolve.csv", index=False)
print(f"Resolve Count is {pivot_table_r["Resolved"].sum()}")
r_ct = pivot_table_r["Resolved"].sum()

# resolved -0

automate = pivot_table_a.loc[pivot_table_a['Assigned to'] == 'automate', 'Assigned']
# Check if result is empty; if yes, print 0, else print the value(s)
if automate.empty:
    automate = 0
else:
    automate = automate.values[0]  # or just print(manual) if you want all matching values

manual = pivot_table_a.loc[pivot_table_a['Assigned to'] == 'Manually', 'Assigned']
# Check if result is empty; if yes, print 0, else print the value(s)
if manual.empty:
    manual = 0
else:
    manual = manual.values[0]  # or just print(manual) if you want all matching values
    

print(f"Automate : {automate}")
# print(f"Manual : {manual}")

df_final = pd.DataFrame(columns=['Lead'])
df_final['Lead'] = lead_alias

df_final = pd.merge(df_final, pivot_table_a, how='left', left_on="Lead", right_on="Assigned to")
df_final = pd.merge(df_final, pivot_table_p, how='left', left_on="Lead", right_on="Assigned to")
df_final = pd.merge(df_final, pivot_table_r, how='left', left_on="Lead", right_on="Last resolved by")

df_final = df_final[["Lead", "Assigned", "Pending-Other activity", "Pending-MB", "Resolved"]]
df_final.sort_values(by='Resolved', ascending=False,  inplace=True)
df_final.fillna(0, inplace=True)
df_final[["Assigned", "Pending-Other activity", "Pending-MB", "Resolved"]] = df_final[["Assigned", "Pending-Other activity", "Pending-MB", "Resolved"]].astype('int32')

pct1 = df_final[["Assigned", "Pending-Other activity", "Pending-MB"]].sum().sum()
print("Total Pending :", pct1)

with pd.ExcelWriter("Summary.xlsx", engine='xlsxwriter') as writer:
    workbook = writer.book
    worksheet = workbook.add_worksheet('Sheet1')
    writer.sheets['Sheet1'] = worksheet
    
    # Write something in row 0 (1st row)
    worksheet.set_column('A:A', 20)
    worksheet.set_column('B:B', 14)
    
    # Format: center aligned, light blue background, bold, no borders
    cell_format_1 = workbook.add_format({
        'align': 'center',
        'valign': 'vcenter',
        'bg_color': '#ADD8E6',  # Light blue
        'bold': True,
        'border': 1
        # No border properties included here
    })

    # Format: center aligned, light blue background, bold, no borders
    cell_format_2 = workbook.add_format({
        'align': 'center',
        'valign': 'vcenter',
        'bg_color': '#ADD8E6',  # Light blue
        'bold': True
        # No border properties included here
    })
    worksheet.write('A1', 'Automate', cell_format_1)
    worksheet.write('A2', 'Queue Size', cell_format_1)
    
    # Merge B1:D1 with the above format
    worksheet.merge_range(0, 1, 0, 4, automate, cell_format_2)
    worksheet.merge_range(1, 1, 1, 4, pct1 + automate, cell_format_2)
    
    for col_num, value in enumerate(df_final.columns):
        worksheet.write(2, col_num, value, cell_format_2)
        
    df_final.to_excel(writer, index=False, header=False, startrow=3, sheet_name='Sheet1')
    
    worksheet.write(3+len(df_final), 0, "Total", cell_format_2)
    worksheet.write(3+len(df_final), 1, df_final["Assigned"].sum(), cell_format_2)
    worksheet.write(3+len(df_final), 2, df_final["Pending-Other activity"].sum(), cell_format_2)
    worksheet.write(3+len(df_final), 3, df_final["Pending-MB"].sum(), cell_format_2)
    worksheet.write(3+len(df_final), 4, df_final["Resolved"].sum(), cell_format_2)
    

# draft mail

html1="""<!DOCTYPE html>
<html>
<head>
    <style>
        table {
            border-collapse: collapse;
            text-align: center;            
        }
        th, td {            
            font-family: calibri;
            padding-right: 30px;
            padding-left: 30px;
            margin: 0;
            font-size: 15px; /* Reduce font size */
            height: 20px;     /* Desired height */
        }
        thead tr,
        tfoot tr {
            background-color: cadetblue;
            color: white;
        }
    </style>
</head>
<body>
<div>Hello Team,</div>
<p><mark>Please find the queue status</p>
<table border="1">
    <thead>
        <tr>
            <th>Lead</th>
            <th>Assigned</th>
            <th>Pending-Other activity</th>
            <th>Pending-MB</th>
            <th>Resolved</th>
        </tr>
    </thead>
    <tbody>
    """

html2 = ""
for index, row in df_final.iterrows():
    
    html2 = html2 + "<tr>\
    <td>"+str(row["Lead"])+"</td>\
    <td>"+str(row["Assigned"])+"</td>\
    <td>"+str(row["Pending-Other activity"])+"</td>\
    <td>"+str(row["Pending-MB"])+"</td>\
    <td>"+str(row["Resolved"])+"</td>\
    </tr>"


html3 = f"""        
    </tbody>
    <tfoot>
        <tr>
            <td >Total</td>
            <td>{df_final["Assigned"].sum()}</td>
            <td>{df_final["Pending-Other activity"].sum()}</td>
            <td>{df_final["Pending-MB"].sum()}</td>
            <td>{df_final["Resolved"].sum()}</td>
        </tr>
    </tfoot>
</table>
<p style="font-family: 'Courier New', Courier, monospace;">Thanks, RBS Team</p>
</body>
</html>
"""
    
html1 = html1 + html2 + html3

with open("output.html", "w", encoding="utf-8") as f:
    f.write(html1)
    
def send_outlook_email(subject, body_html, to_recipients, cc_recipients):
    outlook = win32.Dispatch('Outlook.Application')
    mail = outlook.CreateItem(0)  # 0 = olMailItem
    mail.Subject = subject
    mail.HTMLBody = body_html
    mail.To = ";".join(to_recipients)  # multiple recipients separated by ;
    mail.Cc = ";".join(cc_recipients)  # multiple recipients separated by ;
    mail.save()  # Use mail.Display() if you want to review before sending


with open("email.txt", mode="r") as f:
    f1 = f.read()
    f1 = f1.splitlines()
    
f1 = [x for x in f1 if x and x.strip()]
cc_loc = f1.index("cc")
toli = f1[1:cc_loc]
ccli = f1[cc_loc+1:]

send_outlook_email("Daily Report", html1, toli, ccli)



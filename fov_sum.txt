# fov_cal_50_v1

import re
import time
import pandas as pd
from pathlib import Path
from time import sleep
from openpyxl import Workbook
from tqdm import tqdm

from selenium import webdriver
from selenium.webdriver.support.wait import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.common.by import By
from selenium.webdriver.chrome.options import Options
import traceback
from tqdm import tqdm
from selenium.webdriver.support.ui import Select
from selenium.webdriver.common.action_chains import ActionChains


def set_chrome_options():
    profile = 'Default'
    profile_path = f'C:\\Users\\rhgokula\\AppData\\Local\\Google\\Chrome\\User Data\\Default'

    options = Options()
    options.add_argument(f'--profile-directory={profile}')
    options.add_argument(f'user-data-dir={profile_path}')
    options.add_argument('--no-sandbox')
    options.add_argument("--log-level=3")
    options.add_argument('--disable-gpu')
    options.add_argument("--disable-session-crashed-bubble")
    options.add_argument("--no-first-run")
    options.add_argument("--no-default-browser-check")
    # options.add_argument("--window-size=1920,1080") # Set window size
    # options.add_argument("--window-position=0,0")   # Set window position (X,Y)
    options.add_argument("--start-maximized")
    # options.add_argument("--disable-infobars")
    options.add_argument('--disable-dev-shm-usage')
    # options.add_argument("--disable-blink-features=AutomationControlled")
    options.add_experimental_option('excludeSwitches', ['enable-logging'])
    options.add_experimental_option("prefs", {
        "download.default_directory": str(DOWNLOAD_PATH),
        "download.prompt_for_download": False,
        "download.directory_upgrade": True,
        "safebrowsing.enabled": True
    })
    return options
    

# prepare the folder
DOWNLOAD_PATH = Path("downloads").resolve()
DOWNLOAD_PATH.mkdir(parents=True, exist_ok=True)

# clean up folder
for item in DOWNLOAD_PATH.iterdir():
    if item.is_file() or item.is_symlink():
        item.unlink()

try:
    df_in = pd.read_excel("input.xlsx")
    options = set_chrome_options()

    with webdriver.Chrome(options=options) as driver:
        driver.set_window_size(1920, 1080) # set size
        driver.set_window_position(0, 0)   # top-left corner
        wait80 = WebDriverWait(driver, 80, poll_frequency=1)

        driver.get("https://eu.forecasting-portal.scot.amazon.dev")
        wait80.until(EC.visibility_of_element_located((By.ID, "sc-navbar-container")))

        for index, row in tqdm(df_in.iterrows(), total=df_in.shape[0], desc="Task"):
            driver.get(f"https://eu.winston.a2z.com/EU/task/{row['task']}")
            wait80.until(EC.visibility_of_element_located((By.TAG_NAME, "awsui-spinner")))
            wait80.until(EC.invisibility_of_element_located((By.TAG_NAME, "awsui-spinner")))
            # time.sleep(10)
            wait80.until(
            lambda d: len(d.find_element(By.ID, "winston-body").text) > 100
            )
            bodyText=wait80.until(EC.visibility_of_element_located((By.ID, "winston-body"))).text

            pattern = r'bulkUploadHarmony_\d{13}(?!\d)'

            # Find all matches
            matches = re.findall(pattern, bodyText)

            if len(matches) != 1 :
                df_in.at[index, "P90"] = 0
                continue

            for match in matches:
                driver.get(f"https://eu.forecasting-portal.scot.amazon.dev/overrides/batch/{match}")
                wait80.until(EC.visibility_of_element_located((By.XPATH, "//button[.//span[normalize-space()='Download']]")))
                sleep(1)
                
                # Get all files (not folders)
                f1 = {f for f in DOWNLOAD_PATH.iterdir() if f.is_file()}
                
                driver.find_element(By.XPATH, "//button[.//span[normalize-space()='Download']]").click()
                sleep(2)

                for _ in range(10):
                    # check for the file downloaded
                    f2 = {f for f in DOWNLOAD_PATH.iterdir() if f.is_file()}
                    f3 = f2 - f1
                    f3 = next(iter(f3), None)

                    if f3 and f3.suffix.lower() == ".txt":
                        df=pd.read_csv(f3, sep="\t")
                        # Normalize all column names to lowercase
                        df.columns = df.columns.str.lower()
                        # filter the 90
                        df = df[df["quantile"]==90]
                        # Columns to exclude
                        exclude_cols = ["asin", "reason", "quantile", "fcstgroupid"]
                        # Sum of remaining columns
                        sum_90 = df.drop(columns=exclude_cols).sum().sum()
                        df_in.at[index, "P90"] = sum_90
                        break

                    sleep(2)
                else:
                    print("Download error on", row["task"])

        

        
except Exception as e:
    
    # print("Error:", e)
    # traceback.print_exc()
    # Capture traceback as string
    error_text = traceback.format_exc()
    # Write to a text file
    with open("error_log.txt", "w") as f:
        f.write(error_text)

    print("Traceback saved to error_log.txt")

finally:
    df_in.to_excel("OutputFinal.xlsx", index=False)
    # pass

